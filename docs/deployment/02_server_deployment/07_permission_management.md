# AI 中台 - 账户权限管理方案

本文档详细阐述了 AI 中台的账户权限管理方案，旨在确保系统的安全性、合规性以及资源的合理分配和使用。方案设计参考了 `docs/Outline.md` 中定义的权限管理架构。

## 1. 概述

AI 中台的权限管理系统是一个多层次、多维度的体系，涵盖了从基础设施到应用服务的各个方面。其核心目标是实现对用户身份的有效认证、对操作行为的精确授权以及对权限状态的持续监控。

关键组件和技术栈包括：

-   **身份认证**: Keycloak / Auth0 (前端), Django REST Framework + JWT (后端), Kubernetes ServiceAccount。
-   **应用层权限**: Django + Django-Guardian, Open Policy Agent (OPA)。
-   **系统层权限**: Kubernetes RBAC, Calico / Cilium 网络策略。
-   **存储层权限**: PostgreSQL 用户和角色, MinIO policies, Kafka ACLs。
-   **资源与操作权限**: Harbor 用户管理, MLflow & Kubeflow 权限控制, Redis ACLs。
-   **统一管理与监控**: Hashicorp Vault (密钥管理), Apache Ranger (可选的统一策略管理), ELK Stack, Prometheus, OpenTelemetry。

## 2.核心概念

-   **用户 (User)**: 系统中的操作实体，可以是具体的人员或外部服务。
-   **用户组 (Group)**: 具有相似权限需求的用户集合，简化权限分配和管理。
-   **角色 (Role)**: 一组预定义的权限集合，代表了用户在系统中的职责或身份。用户可以被分配一个或多个角色。
-   **权限 (Permission)**: 对特定资源执行特定操作的许可。例如，对某个数据集的读取权限，或部署某个模型的权限。
-   **资源 (Resource)**: 系统中需要被保护和控制访问的对象，如数据、模型、计算资源、API 端点等。

## 3. 身份认证 (Identity Authentication)

身份认证是权限管理的第一道防线，确保只有合法的用户才能访问系统。

-   **前端/用户界面**: 推荐使用 **Keycloak** 或 **Auth0** 作为身份和访问管理 (IAM) 解决方案。它们提供单点登录 (SSO)、多因素认证 (MFA)、社交登录等功能，并能与后端服务集成。
-   **后端 API 服务**: 后端 API (基于 Django REST Framework) 将使用 **JWT (JSON Web Tokens)** 进行无状态认证。用户通过 Keycloak/Auth0 登录后，获得 JWT，后续请求 API 时携带此 Token。
    -   `djangorestframework-simplejwt` 库用于 JWT 的生成、验证和刷新。
-   **Kubernetes 内部服务**: Kubernetes **ServiceAccount** 用于为 Pod 分配身份，使其能够安全地访问 Kubernetes API 或其他集群内服务。可以考虑将 Keycloak 与 Kubernetes ServiceAccount 进行同步，以统一用户身份。

## 4. 管理权限

管理权限主要针对中台的运维和管理人员，允许他们配置系统、管理用户、监控服务等。

-   **中台管理后台 (Django Admin)**: Django 自带的 Admin 后台可以用于基础的用户和权限管理。通过定义不同的用户组和权限，可以授予管理员不同级别的管理能力。
-   **Kubernetes RBAC**: 对于 Kubernetes 集群资源的管理，将严格使用 RBAC 策略。定义不同的 `Roles` 和 `ClusterRoles`，并将其绑定到特定的 `ServiceAccounts` 或用户组。
-   **基础设施组件管理**: 各基础设施组件（如 Harbor, MinIO, ELK）通常自带用户和权限管理界面或 API，应配置相应的管理员账户和权限。

## 5. 应用权限

应用权限控制用户对中台各个应用模块（如数据中台、算法中台、模型中台）及其内部功能的访问。

-   **基于角色的访问控制 (RBAC)**: 这是应用权限的核心模型。为每个应用模块定义清晰的角色（如数据分析师、模型开发者、应用运维者），并为这些角色分配具体的功能操作权限。
-   **Django + Django-Guardian**: 对于基于 Django 构建的应用模块，可以使用 `django-guardian` 实现对象级权限管理。这意味着可以控制用户对特定数据记录、模型实例等具体对象的访问权限，而不仅仅是类级别的权限。
    -   例如，用户 A 可能只能访问项目 X 的数据集，而用户 B 可以访问项目 Y 的数据集。
-   **Open Policy Agent (OPA)**: OPA 是一种通用的策略引擎，可以用于在微服务架构中实现细粒度的访问控制。可以将 OPA 集成到 API 网关或各个服务中，根据预定义的策略（使用 Rego 语言编写）来决定是否允许某个请求。
    -   OPA 尤其适用于需要复杂逻辑判断或跨服务权限决策的场景。

## 6. 资源权限

资源权限关注对具体数据和计算资源的访问控制。

### 6.1. 存储层资源

-   **PostgreSQL 16**: 通过数据库用户、角色和 `GRANT`/`REVOKE` 语句来控制对数据库、表、视图、函数等级别的访问权限。用户权限信息也存储在 PostgreSQL 中。
-   **MinIO**: 使用 MinIO 的 IAM 策略 (Policies) 来控制对存储桶 (Buckets) 和对象 (Objects) 的访问。可以定义基于用户、组或服务账户的策略。
-   **Kafka 3.6**: 使用 Kafka ACLs (Access Control Lists) 来控制对 Topic 的生产 (Produce) 和消费 (Consume) 权限，以及对 Consumer Group 的管理权限。

### 6.2. 计算与模型资源

-   **Kubernetes 资源**: 如前所述，通过 RBAC 控制对 Namespace、Pod、Deployment 等 Kubernetes 资源的访问。结合 Namespace 可以实现多租户的资源隔离。
-   **GPU 资源**: NVIDIA Device Plugin 结合 Kubernetes 的资源请求和限制机制，可以分配 GPU 给特定的 Pod。更细粒度的 GPU 共享和权限管理可能需要商业解决方案或更复杂的自定义调度。
-   **Harbor**: 控制对 Docker 镜像仓库的访问，包括镜像的推送、拉取权限，以及项目的成员管理。
-   **MLflow & Kubeflow**: 这类 MLOps平台通常内置了实验、模型、流水线等资源的权限管理机制，需要根据其文档进行配置，确保用户只能访问其授权的项目和资源。
-   **Redis ACL**: Redis 6.0 及以上版本支持 ACL，可以精细控制用户对命令和键的访问权限。

## 7. 统一权限管理与审计

为了简化管理和增强安全性，可以考虑引入统一的权限管理和审计工具。

-   **Hashicorp Vault**: 主要用于敏感凭证（如 API 密钥、数据库密码、证书）的安全存储和管理。应用程序可以从 Vault 动态获取凭证，而不是硬编码或存储在配置文件中。
-   **Apache Ranger** (可选): 如果需要一个集中的策略管理平台来统一管理跨多个数据存储和处理引擎（如 HDFS, Hive, Kafka, Solr）的权限策略，可以考虑引入 Apache Ranger。集成 Ranger 需要相应组件提供 Ranger 插件。
-   **UI 界面**: 中台管理系统应提供一个统一的权限管理 UI 界面，方便管理员进行用户、角色、权限的配置和审计。该界面后端将调用 Django API 和其他相关服务的 API。

### 7.1. 统一账户权限配置流程

为了方便地为某一账户配置其在不同功能层（应用层、资源层、管理层）的权限，中台管理系统将提供一个集中的用户权限管理模块。其核心思路如下：

1.  **基于角色的访问控制 (RBAC) 为核心**:
    *   预先定义好系统中的各种角色（如“数据科学家”、“运维工程师”、“项目管理员”、“普通用户”等）。
    *   每个角色关联一组跨越不同功能层的权限模板。例如，“数据科学家”角色可能默认拥有访问特定数据集的权限（资源权限）、使用数据分析工具的权限（应用权限）、查看项目日志的权限（管理权限）。

2.  **统一用户管理界面**:
    *   **用户创建与信息管理**: 管理员通过 UI 创建用户账户或同步来自外部身份提供商（如 Keycloak）的用户信息。
    *   **角色分配**: 管理员可以直接为用户分配一个或多个预定义的角色。用户将自动继承这些角色所包含的所有权限。这是最主要的权限配置方式。
    *   **细粒度权限调整 (可选与慎用)**:
        *   在某些特殊情况下，除了角色赋予的权限外，可能需要为单个用户授予或撤销特定的细粒度权限。UI 界面应允许管理员查看用户通过角色继承的权限，并能在此基础上进行微调。
        *   例如，某个“数据科学家”角色的用户，可能需要额外访问一个特定项目的敏感数据，管理员可以单独为该用户添加此项对象级权限（如通过 `django-guardian` 实现）。
        *   这种直接的权限调整应有明确的审批和记录，避免权限混乱。

3.  **权限配置的后端实现**:
    *   **Django 作为权限中枢**: 中台管理后台的 Django 应用将作为权限配置的核心。
        *   存储用户、角色、用户与角色的关联关系。
        *   提供 API 供前端 UI 调用，用于查询和修改用户的角色及细粒度权限。
    *   **与各功能层权限系统的联动**:
        *   **应用层权限 (Django-Guardian, OPA)**: 当通过 UI 为用户分配角色或调整权限时，Django 后端会更新其自身的权限数据库（例如 `django-guardian` 的权限表）。如果使用 OPA，Django 后端可能需要调用 OPA 的管理 API 来更新相关策略或数据。
        *   **资源层权限 (PostgreSQL, MinIO, Kafka等)**:
            *   对于数据库权限，Django 后端在处理角色分配或特定资源授权时，可能需要执行相应的 SQL（如 `GRANT`/`REVOKE`）或调用数据库管理 API。这通常需要一个具有足够权限的服务账户来操作数据库。
            *   对于 MinIO、Kafka 等，Django 后端可以通过调用这些服务提供的管理 API 来更新用户的访问策略或 ACLs。
            *   **挑战与方案**: 直接让 Django 应用去操作所有底层资源的权限系统会增加耦合度和复杂性。一种更解耦的方式是：
                *   **事件驱动/消息队列**: 当用户权限在 Django 中发生变更时，发布一个权限变更事件到消息队列 (如 Kafka)。
                *   **专用权限同步服务**: 各个功能层或资源系统可以有专门的轻量级服务订阅这些事件，并根据事件内容更新各自的权限配置。
                *   **定期同步/轮询**: 作为补充，也可以有定时任务检查 Django 中的权限配置，并与各系统的实际权限状态进行同步。
        *   **系统层权限 (Kubernetes RBAC)**: 对 Kubernetes 资源的权限通常通过声明式的 YAML 文件定义 `Roles` 和 `RoleBindings`。统一管理界面可以提供一种方式来可视化或引导管理员创建/修改这些配置，但最终仍需通过 `kubectl apply` 或 Kubernetes API 来生效。对于动态的、基于用户属性的 Kubernetes 权限，可以考虑与 Keycloak 等身份提供商集成，利用其用户组信息来动态生成 `RoleBindings`。

4.  **权限视图与审计**:
    *   UI 界面应提供清晰的视图，让管理员可以方便地查看任一用户当前拥有的所有权限（包括通过角色继承的和单独分配的），以及这些权限的来源。
    *   所有权限变更操作都必须被详细记录审计日志，包括操作人、操作时间、变更内容等。

通过这种方式，管理员可以在一个集中的界面上管理用户的核心角色，并通过角色模板间接控制其在各个功能层的权限。对于特殊情况，可以进行细粒度的调整，同时保证操作的可追溯性。这种设计在易用性和灵活性之间取得了平衡。

## 8. 权限监控与审计

持续监控权限相关的活动对于及时发现和响应安全威胁至关重要。

-   **ELK Stack (Elasticsearch, Logstash, Kibana)**: 收集和分析来自各个系统组件（操作系统、Kubernetes、Django 应用、数据库等）的审计日志和访问日志。可以创建仪表盘来可视化权限相关的事件，如登录失败、权限变更、未授权访问尝试等。
-   **Prometheus + Grafana**: 监控关键服务的认证和授权相关的指标，例如认证请求的成功率和延迟、授权拒绝的次数等。
-   **OpenTelemetry**: 用于生成和收集分布式追踪、指标和日志数据，可以帮助理解在复杂调用链中权限是如何被检查和执行的。

## 9. 实施策略与最佳实践

-   **最小权限原则**: 用户和服务只应被授予其完成任务所必需的最小权限。
-   **定期审计**: 定期审查用户权限和角色分配，移除不再需要的权限。
-   **职责分离**: 关键操作和管理权限应分配给不同的角色或用户，避免单点风险。
-   **强密码策略与 MFA**: 对所有用户账户强制执行强密码策略，并对管理员和高权限用户启用多因素认证 (MFA)。
-   **安全培训**: 对中台用户和管理员进行安全意识和权限管理相关的培训。
-   **自动化**: 尽可能自动化权限的分配、撤销和审计过程，减少人工错误。
-   **版本控制**: 权限策略（如 OPA 策略、Kubernetes RBAC 配置）应纳入版本控制系统进行管理。

---

**后续步骤**:
根据此方案，逐步设计和实现各个组件的权限配置，并在中台管理系统中开发相应的权限管理功能模块。
