import uuid
from datetime import datetime
from django.utils import timezone
from django.db import models
from rest_framework import viewsets, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from django_filters.rest_framework import DjangoFilterBackend
from rest_framework.filters import SearchFilter, OrderingFilter

from .models import AlgorithmProject, Experiment, ExperimentRun, Algorithm
from .serializers import (
    AlgorithmProjectSerializer, ExperimentSerializer, ExperimentRunSerializer,
    AlgorithmSerializer, ExperimentCreateSerializer
)


class AlgorithmProjectViewSet(viewsets.ModelViewSet):
    """ç®—æ³•é¡¹ç›®ViewSet"""
    queryset = AlgorithmProject.objects.all()
    serializer_class = AlgorithmProjectSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_fields = ['framework', 'is_active']
    search_fields = ['name', 'description']
    ordering_fields = ['created_at', 'updated_at', 'name']    def get_queryset(self):
        """åªè¿”å›å½“å‰ç”¨æˆ·ç»„ç»‡çš„é¡¹ç›®"""
        return AlgorithmProject.objects.filter(
            organization=self.request.user.profile.organization
        )    def perform_create(self, serializer):
        """åˆ›å»ºé¡¹ç›®æ—¶è®¾ç½®ç»„ç»‡å’Œåˆ›å»ºè€?""
        serializer.save(
            organization=self.request.user.profile.organization,
            created_by=self.request.user
        )

    @action(detail=True, methods=['get'])
    def experiments(self, request, pk=None):
        """è·å–é¡¹ç›®ä¸‹çš„æ‰€æœ‰å®éª?""
        project = self.get_object()
        experiments = project.experiments.all()
        serializer = ExperimentSerializer(experiments, many=True)
        return Response(serializer.data)

    @action(detail=True, methods=['post'])
    def clone(self, request, pk=None):
        """å…‹éš†é¡¹ç›®"""
        original_project = self.get_object()
        new_name = request.data.get('name', f"{original_project.name}_copy")
        
        # åˆ›å»ºæ–°é¡¹ç›?
        new_project = AlgorithmProject.objects.create(
            name=new_name,
            description=f"å…‹éš†è‡? {original_project.name}",
            organization=self.request.user.profile.organization,
            created_by=self.request.user,
            framework=original_project.framework,
            environment_config=original_project.environment_config,
            git_repository=original_project.git_repository
        )
        
        serializer = self.get_serializer(new_project)
        return Response(serializer.data, status=status.HTTP_201_CREATED)


class ExperimentViewSet(viewsets.ModelViewSet):
    """å®éªŒViewSet"""
    queryset = Experiment.objects.all()
    serializer_class = ExperimentSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_fields = ['project', 'algorithm_type', 'status', 'dataset']
    search_fields = ['name', 'description']
    ordering_fields = ['created_at', 'updated_at', 'started_at', 'completed_at']

    def get_queryset(self):
        """åªè¿”å›å½“å‰ç”¨æˆ·ç»„ç»‡çš„å®éªŒ"""
        return Experiment.objects.filter(
            project__organization=self.request.user.profile.organization
        )

    def get_serializer_class(self):
        if self.action == 'create':
            return ExperimentCreateSerializer
        return ExperimentSerializer

    def perform_create(self, serializer):
        """åˆ›å»ºå®éªŒæ—¶è®¾ç½®åˆ›å»ºè€?""
        serializer.save(created_by=self.request.user)

    @action(detail=True, methods=['post'])
    def start(self, request, pk=None):
        """å¯åŠ¨å®éªŒ"""
        experiment = self.get_object()
        
        if experiment.status != 'created':
            return Response({
                'error': 'åªèƒ½å¯åŠ¨å·²åˆ›å»ºçŠ¶æ€çš„å®éªŒ'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        # æ›´æ–°å®éªŒçŠ¶æ€?
        experiment.status = 'running'
        experiment.started_at = timezone.now()
        experiment.save()
        
        # åˆ›å»ºå®éªŒè¿è¡Œè®°å½•
        run = ExperimentRun.objects.create(
            experiment=experiment,
            run_id=str(uuid.uuid4()),
            version=experiment.runs.count() + 1,
            parameters=experiment.hyperparameters,
            status='running',
            started_at=timezone.now()
        )
        
        # è¿™é‡Œå¯ä»¥å®ç°å…·ä½“çš„å®éªŒæ‰§è¡Œé€»è¾‘
        # ç›®å‰è¿”å›æ¨¡æ‹Ÿç»“æœ
        
        return Response({
            'message': f'å®éªŒ {experiment.name} å·²å¯åŠ?,
            'run_id': run.run_id
        })

    @action(detail=True, methods=['post'])
    def stop(self, request, pk=None):
        """åœæ­¢å®éªŒ"""
        experiment = self.get_object()
        
        if experiment.status != 'running':
            return Response({
                'error': 'åªèƒ½åœæ­¢è¿è¡Œä¸­çš„å®éªŒ'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        experiment.status = 'stopped'
        experiment.save()
        
        # åœæ­¢æœ€æ–°çš„è¿è¡Œè®°å½•
        latest_run = experiment.runs.filter(status='running').first()
        if latest_run:
            latest_run.status = 'killed'
            latest_run.ended_at = timezone.now()
            latest_run.save()
        
        return Response({
            'message': f'å®éªŒ {experiment.name} å·²åœæ­?
        })

    @action(detail=True, methods=['get'])
    def runs(self, request, pk=None):
        """è·å–å®éªŒçš„æ‰€æœ‰è¿è¡Œè®°å½?""
        experiment = self.get_object()
        runs = experiment.runs.all()
        serializer = ExperimentRunSerializer(runs, many=True)
        return Response(serializer.data)

    @action(detail=True, methods=['get'])
    def metrics(self, request, pk=None):
        """è·å–å®éªŒçš„è¯„ä¼°æŒ‡æ ‡å†å?""
        experiment = self.get_object()
        runs = experiment.runs.filter(status='completed').order_by('version')
        
        metrics_history = []
        for run in runs:
            if run.metrics:
                metrics_data = {
                    'version': run.version,
                    'run_id': run.run_id,
                    'started_at': run.started_at,
                    'metrics': run.metrics
                }
                metrics_history.append(metrics_data)
        
        return Response({'metrics_history': metrics_history})


class ExperimentRunViewSet(viewsets.ModelViewSet):
    """å®éªŒè¿è¡Œè®°å½•ViewSet"""
    queryset = ExperimentRun.objects.all()
    serializer_class = ExperimentRunSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_fields = ['experiment', 'status', 'version']
    search_fields = ['run_id']
    ordering_fields = ['created_at', 'started_at', 'ended_at', 'version']

    def get_queryset(self):
        """åªè¿”å›å½“å‰ç”¨æˆ·ç»„ç»‡çš„è¿è¡Œè®°å½•"""
        return ExperimentRun.objects.filter(
            experiment__project__organization=self.request.user.profile.organization
        )

    @action(detail=True, methods=['get'])
    def logs(self, request, pk=None):
        """è·å–è¿è¡Œæ—¥å¿—"""
        run = self.get_object()
        # è¿™é‡Œå¯ä»¥å®ç°ä»æ—¥å¿—æ–‡ä»¶æˆ–æ—¥å¿—ç³»ç»Ÿè¯»å–æ—¥å¿—
        logs = run.logs or "æš‚æ— æ—¥å¿—è®°å½•"
        return Response({'logs': logs})

    @action(detail=True, methods=['get'])
    def artifacts(self, request, pk=None):
        """è·å–è¿è¡Œäº§å‡ºæ–‡ä»¶"""
        run = self.get_object()
        return Response({'artifacts': run.artifacts})

    @action(detail=True, methods=['post'])
    def compare(self, request, pk=None):
        """æ¯”è¾ƒå¤šä¸ªè¿è¡Œç»“æœ"""
        run = self.get_object()
        compare_run_ids = request.data.get('compare_with', [])
        
        comparison_data = {
            'base_run': {
                'run_id': run.run_id,
                'version': run.version,
                'metrics': run.metrics,
                'parameters': run.parameters
            },
            'compared_runs': []
        }
        
        for run_id in compare_run_ids:
            try:
                compare_run = ExperimentRun.objects.get(run_id=run_id)
                comparison_data['compared_runs'].append({
                    'run_id': compare_run.run_id,
                    'version': compare_run.version,
                    'metrics': compare_run.metrics,
                    'parameters': compare_run.parameters
                })
            except ExperimentRun.DoesNotExist:
                continue
        
        return Response(comparison_data)


class AlgorithmViewSet(viewsets.ModelViewSet):
    """ç®—æ³•æ¨¡æ¿ViewSet"""
    queryset = Algorithm.objects.all()
    serializer_class = AlgorithmSerializer
    permission_classes = [IsAuthenticated]
    filter_backends = [DjangoFilterBackend, SearchFilter, OrderingFilter]
    filterset_fields = ['category', 'framework', 'is_builtin', 'is_active']
    search_fields = ['name', 'description', 'author']
    ordering_fields = ['created_at', 'updated_at', 'name', 'version']

    def get_queryset(self):
        """è¿”å›å†…ç½®ç®—æ³•å’Œå½“å‰ç”¨æˆ·ç»„ç»‡çš„è‡ªå®šä¹‰ç®—æ³?""
        user_org = self.request.user.profile.organization
        return Algorithm.objects.filter(
            models.Q(is_builtin=True) | models.Q(organization=user_org)
        )

    def perform_create(self, serializer):
        """åˆ›å»ºç®—æ³•æ—¶è®¾ç½®ç»„ç»?""
        serializer.save(
            organization=self.request.user.profile.organization,
            is_builtin=False
        )

    @action(detail=True, methods=['get'])
    def template(self, request, pk=None):
        """è·å–ç®—æ³•ä»£ç æ¨¡æ¿"""
        algorithm = self.get_object()
        return Response({
            'name': algorithm.name,
            'code_template': algorithm.code_template,
            'default_parameters': algorithm.default_parameters,
            'framework': algorithm.framework
        })

    @action(detail=True, methods=['post'])
    def clone(self, request, pk=None):
        """å…‹éš†ç®—æ³•æ¨¡æ¿"""
        original_algorithm = self.get_object()
        new_name = request.data.get('name', f"{original_algorithm.name}_copy")
        
        new_algorithm = Algorithm.objects.create(
            name=new_name,
            description=f"å…‹éš†è‡? {original_algorithm.name}",
            category=original_algorithm.category,
            framework=original_algorithm.framework,
            code_template=original_algorithm.code_template,
            default_parameters=original_algorithm.default_parameters,
            author=self.request.user.username,
            version="1.0.0",
            is_builtin=False,
            organization=self.request.user.profile.organization
        )
        
        serializer = self.get_serializer(new_algorithm)
        return Response(serializer.data, status=status.HTTP_201_CREATED)
