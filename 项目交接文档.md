# 🚀 ZTZT AI中台项目交接文档

> **文档版本**: v1.0  
> **更新日期**: 2025年6月26日  
> **交接人**: lsyzt  
> **接收人**: [待填写]  

---

## 📋 目录

1. [项目概况](#-项目概况)
2. [项目架构](#-项目架构)
3. [技术栈](#-技术栈)
4. [服务器环境](#️-服务器环境)
5. [端口占用情况](#-端口占用情况)
6. [🆕 端口冲突解决方案](#-端口冲突解决方案-v20256重要更新)
7. [账号密码信息](#-账号密码信息)
8. [项目目录结构](#-项目目录结构)
9. [快速启动指南](#-快速启动指南)
10. [开发环境配置](#-开发环境配置)
11. [监控和运维](#-监控和运维)
12. [常见问题排查](#-常见问题排查-v20256更新)
13. [重要注意事项](#️-重要注意事项)
14. [联系方式](#-联系方式-v20256更新)

---

## 🎯 项目概况

### 项目简介
ZTZT 是一个企业级的 AI 中台解决方案，提供从开发到生产的全栈 AI 服务平台。项目采用现代化的微服务架构，支持多种部署方式，并提供了从开发、测试到生产的完整解决方案。

### 核心功能
- **🤖 Dify AI 平台集成**: 内置Dify AI应用构建平台，支持对话、工作流、智能体
- **🔧 端口冲突解决**: 智能端口管理，AI中台(80) + Dify(8080)完美协同  
- **🎯 环境管理系统**: 开发/生产环境一键切换，自动配置IP地址
- **🚀 统一访问入口**: 通过端口80提供AI中台统一访问入口
- **📊 四大中台**: 数据平台、算法平台、模型平台、服务平台
- **🔒 权限管理**: 基于 Django + JWT 的完整权限系统
- **📈 监控系统**: Prometheus + Grafana 监控体系
- **🐳 容器化**: Docker + Kubernetes 容器编排
- **🔥 GPU 支持**: NVIDIA GPU 加速推理服务

### 最新架构特性 (v2025.6)
- **🌐 统一入口**: 端口80统一访问AI中台所有功能
- **🤖 AI平台**: 端口8080独立运行Dify AI应用构建平台
- **🔄 环境切换**: 开发/生产环境零配置切换  
- **📦 完全离线**: 所有Docker镜像本地化，无网络依赖
- **🔧 智能部署**: 自动端口管理，避免服务冲突

### 部署环境
- **开发环境**: localhost (127.0.0.1)
- **生产环境**: 192.168.110.88 (Ubuntu 24.04 LTS)

---

## 🏗️ 项目架构

### 系统架构图

```mermaid
graph TB
    subgraph "用户交互层"
        NextJS[Web前端<br/>Next.js]
        DjangoAdmin[Django Admin<br/>后台管理]
        Grafana[Grafana监控<br/>可视化]
        DifyUI[Dify界面<br/>AI平台]
    end
    
    subgraph "API网关/核心服务"
        DjangoAPI[Django REST API<br/>核心API]
        JWT[JWT认证<br/>身份验证]
        Permission[权限管理<br/>RBAC]
        Nginx[Nginx<br/>反向代理]
    end
    
    subgraph "应用中台层"
        DataPlatform[数据平台<br/>Data Platform]
        AlgoPlatform[算法平台<br/>Algorithm Platform]
        ModelPlatform[模型平台<br/>Model Platform]
        ServicePlatform[服务平台<br/>Service Platform]
        DifyPlatform[Dify平台<br/>AI Integration]
    end
    
    subgraph "基础设施层"
        PostgreSQL[(PostgreSQL<br/>主数据库)]
        Redis[(Redis<br/>缓存)]
        MinIO[(MinIO<br/>对象存储)]
        Prometheus[Prometheus<br/>监控收集]
        GPUService[GPU服务<br/>推理加速]
    end
    
    %% 连接关系
    NextJS --> DjangoAPI
    DjangoAdmin --> DjangoAPI
    Grafana --> Prometheus
    DifyUI --> DifyPlatform
    
    DjangoAPI --> JWT
    DjangoAPI --> Permission
    Nginx --> DjangoAPI
    
    DjangoAPI --> DataPlatform
    DjangoAPI --> AlgoPlatform
    DjangoAPI --> ModelPlatform
    DjangoAPI --> ServicePlatform
    DjangoAPI --> DifyPlatform
    
    DataPlatform --> PostgreSQL
    DataPlatform --> Redis
    DataPlatform --> MinIO
    
    AlgoPlatform --> PostgreSQL
    AlgoPlatform --> MinIO
    
    ModelPlatform --> PostgreSQL
    ModelPlatform --> MinIO
    ModelPlatform --> GPUService
    
    ServicePlatform --> PostgreSQL
    ServicePlatform --> Redis
    
    DifyPlatform --> PostgreSQL
    DifyPlatform --> Redis
    
    Prometheus --> PostgreSQL
    Prometheus --> Redis
    Prometheus --> GPUService
    
    %% 样式定义
    classDef frontend fill:#e1f5fe
    classDef api fill:#f3e5f5
    classDef platform fill:#e8f5e8
    classDef infrastructure fill:#fff3e0
    
    class NextJS,DjangoAdmin,Grafana,DifyUI frontend
    class DjangoAPI,JWT,Permission,Nginx api
    class DataPlatform,AlgoPlatform,ModelPlatform,ServicePlatform,DifyPlatform platform
    class PostgreSQL,Redis,MinIO,Prometheus,GPUService infrastructure
```

### 部署架构
- **前端**: Next.js + React + TypeScript
- **后端**: Django + Django REST Framework
- **数据库**: PostgreSQL (主数据库) + Redis (缓存)
- **存储**: MinIO (对象存储)
- **容器化**: Docker + Docker Compose
- **监控**: Prometheus + Grafana
- **AI平台**: Dify 集成

### 网络架构图

```mermaid
graph TB
    subgraph "外部用户"
        User[用户浏览器]
        API_Client[API客户端]
    end
    
    subgraph "服务器: 192.168.110.88"
        subgraph "Web层 - 端口3000,8000,80"
            Nginx[Nginx:80<br/>反向代理]
            NextJS[Next.js:3000<br/>前端服务]
            Django[Django:8000<br/>后端API]
        end
        
        subgraph "应用层"
            DifyAPI[Dify API:5001<br/>AI服务]
            DifyWeb[Dify Web:8001<br/>AI界面]
        end
        
        subgraph "数据层"
            PostgreSQL[PostgreSQL:5432<br/>主数据库]
            PostgreSQL_Dify[PostgreSQL:5433<br/>Dify数据库]
            Redis_Main[Redis:6379<br/>主缓存]
            Redis_Dify[Redis:6380<br/>Dify缓存]
            MinIO[MinIO:9000/9001<br/>对象存储]
        end
        
        subgraph "监控层"
            Prometheus[Prometheus:9090<br/>监控收集]
            Grafana_Main[Grafana:3000<br/>主监控]
            Grafana_GPU[Grafana:3003<br/>GPU监控]
            AlertManager[AlertManager:9093<br/>告警管理]
        end
        
        subgraph "AI/GPU服务"
            GPUStack[GPUStack:8080<br/>GPU管理]
            Ollama[Ollama:11434<br/>LLM服务]
            OpenWebUI[OpenWebUI:3001<br/>AI界面]
            Triton[Triton:8100/8101<br/>推理服务]
        end
    end
    
    subgraph "Docker网络: ai_platform_network"
        Docker_Net[内部服务通信<br/>容器间网络]
    end
    
    %% 外部访问
    User --> Nginx
    User --> NextJS
    User --> Django
    API_Client --> Django
    
    %% 内部服务通信
    Nginx --> NextJS
    Nginx --> Django
    Nginx --> DifyWeb
    
    NextJS --> Django
    Django --> PostgreSQL
    Django --> Redis_Main
    Django --> MinIO
    
    DifyAPI --> PostgreSQL_Dify
    DifyAPI --> Redis_Dify
    DifyWeb --> DifyAPI
    
    Prometheus --> Django
    Prometheus --> PostgreSQL
    Prometheus --> Redis_Main
    Prometheus --> GPUStack
    
    Grafana_Main --> Prometheus
    AlertManager --> Prometheus
    
    %% Docker网络
    Django -.-> Docker_Net
    PostgreSQL -.-> Docker_Net
    Redis_Main -.-> Docker_Net
    MinIO -.-> Docker_Net
    DifyAPI -.-> Docker_Net
    Prometheus -.-> Docker_Net
    
    %% 样式定义
    classDef external fill:#ffcdd2
    classDef web fill:#e1f5fe
    classDef app fill:#f3e5f5
    classDef data fill:#e8f5e8
    classDef monitor fill:#fff3e0
    classDef ai fill:#f1f8e9
    classDef network fill:#fafafa
    
    class User,API_Client external
    class Nginx,NextJS,Django web
    class DifyAPI,DifyWeb app
    class PostgreSQL,PostgreSQL_Dify,Redis_Main,Redis_Dify,MinIO data
    class Prometheus,Grafana_Main,Grafana_GPU,AlertManager monitor
    class GPUStack,Ollama,OpenWebUI,Triton ai
    class Docker_Net network
```

---

## 💻 技术栈

### 后端技术
| 技术 | 版本 | 用途 |
|------|------|------|
| Python | 3.12 | 后端开发语言 |
| Django | 5.1+ | Web框架 |
| Django REST Framework | 3.15+ | API框架 |
| PostgreSQL | 16 | 主数据库 |
| Redis | 7.0 | 缓存系统 |
| MinIO | 最新版 | 对象存储 |

### 前端技术
| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | 18.x LTS | 前端运行时 |
| Next.js | 14+ | React框架 |
| React | 18+ | 前端框架 |
| TypeScript | 5+ | 类型系统 |

### 容器化与部署
| 技术 | 版本 | 用途 |
|------|------|------|
| Docker | 24+ | 容器运行时 |
| Docker Compose | 2.20+ | 容器编排 |
| Nginx | 1.25 | 反向代理 |

### 监控与运维
| 技术 | 版本 | 用途 |
|------|------|------|
| Prometheus | 最新版 | 监控数据收集 |
| Grafana | 最新版 | 监控数据可视化 |
| DCGM Exporter | 最新版 | GPU监控 |

### 数据流架构

```mermaid
flowchart LR
    subgraph "数据输入"
        UserInput[用户输入]
        APIData[API数据]
        FileUpload[文件上传]
    end
    
    subgraph "数据处理层"
        Django[Django后端<br/>数据验证&处理]
        DifyEngine[Dify AI引擎<br/>智能处理]
    end
    
    subgraph "数据存储"
        PostgreSQL[(PostgreSQL<br/>结构化数据)]
        Redis[(Redis<br/>缓存数据)]
        MinIO[(MinIO<br/>文件对象)]
    end
    
    subgraph "AI处理"
        LLM[大语言模型<br/>Ollama/GPT]
        VectorDB[向量数据库<br/>Weaviate]
        GPU[GPU计算<br/>推理加速]
    end
    
    subgraph "数据输出"
        WebUI[Web界面<br/>Next.js]
        APIResponse[API响应<br/>JSON/XML]
        Reports[报告文件<br/>PDF/Excel]
        Alerts[监控告警<br/>邮件/短信]
    end
    
    %% 数据流向
    UserInput --> Django
    APIData --> Django
    FileUpload --> MinIO
    
    Django --> PostgreSQL
    Django --> Redis
    Django --> DifyEngine
    
    DifyEngine --> LLM
    DifyEngine --> VectorDB
    LLM --> GPU
    
    PostgreSQL --> Django
    Redis --> Django
    MinIO --> Django
    
    Django --> WebUI
    Django --> APIResponse
    Django --> Reports
    
    Django --> Prometheus[监控数据] --> Alerts
    
    %% 样式定义
    classDef input fill:#e3f2fd
    classDef process fill:#f3e5f5
    classDef storage fill:#e8f5e8
    classDef ai fill:#fff3e0
    classDef output fill:#fce4ec
    
    class UserInput,APIData,FileUpload input
    class Django,DifyEngine process
    class PostgreSQL,Redis,MinIO storage
    class LLM,VectorDB,GPU ai
    class WebUI,APIResponse,Reports,Alerts output
```

---

## 🖥️ 服务器环境

### 生产服务器信息
| 项目 | 详情 |
|------|------|
| **服务器IP** | `192.168.110.88` |
| **操作系统** | Ubuntu 24.04 LTS |
| **用户名** | `lsyzt` |
| **SSH端口** | `22` |
| **项目路径** | `/home/lsyzt/ZTZT` |
| **最小化示例路径** | `/home/lsyzt/ZTZT/minimal-example` |

### SSH连接命令
```bash
# 从任何地方连接到服务器
ssh lsyzt@192.168.110.88

# Windows用户推荐使用的工具
# - Windows Terminal + OpenSSH
# - VSCode Remote SSH 插件
# - MobaXterm (图形化工具)
```

### 重要目录结构
```
/home/lsyzt/ZTZT/
├── minimal-example/          # 最小化AI中台示例
│   ├── backend/             # Django后端应用
│   ├── frontend/            # Next.js前端应用
│   ├── docker/              # Docker配置文件
│   ├── quick-start.sh       # 快速启动脚本
│   └── stop.sh              # 停止脚本
├── docs/                    # 完整文档
├── dify/                    # Dify AI平台源码
└── packages/                # 软件包资源
```

---

## 🔌 端口占用情况

### 端口分布图 (⚠️ 2025.6更新)

```mermaid
graph TB
    subgraph "Web服务层 (80, 3000-8999)"
        Port80[80: AI中台统一入口 🆕]
        Port3000[3000: Next.js前端]
        Port3002[3002: Grafana监控]
        Port8000[8000: Django后端]
        Port8080[8080: Dify AI平台 🆕]
        Port8100[8100: Triton HTTP]
        Port8101[8101: Triton GRPC]
    end
    
    subgraph "数据库层 (5000-6999)"
        Port5432[5432: PostgreSQL主库]
        Port5433[5433: PostgreSQL Dify]
        Port6379[6379: Redis主缓存]
        Port6380[6380: Redis Dify]
    end
    
    subgraph "监控服务层 (9000-9999)"
        Port9000[9000: MinIO API]
        Port9001[9001: MinIO控制台]
        Port9090[9090: Prometheus]
        Port9093[9093: AlertManager]
        Port9100[9100: Node Exporter]
        Port9121[9121: Redis Exporter]
        Port9187[9187: PostgreSQL Exporter]
    end
    
    subgraph "AI服务层 (11000+)"
        Port11434[11434: Ollama LLM]
        Port3001[3001: OpenWebUI]
    end
    
    subgraph "基础服务层 (0-2999)"
        Port22[22: SSH]
        Port80[80: Nginx]
        Port443[443: HTTPS]
        Port27017[27017: MongoDB]
    end
    
    subgraph "特殊端口"
        Port5001[5001: Dify API]
        Port5555[5555: Flower监控]
    end
    
    %% 样式定义
    classDef web fill:#e3f2fd
    classDef database fill:#e8f5e8
    classDef monitor fill:#fff8e1
    classDef ai fill:#f1f8e9
    classDef basic fill:#fce4ec
    classDef special fill:#f3e5f5
    
    class Port3000,Port3003,Port8000,Port8001,Port8080,Port8100,Port8101 web
    class Port5432,Port5433,Port6379,Port6380 database
    class Port9000,Port9001,Port9090,Port9093,Port9100,Port9121,Port9187 monitor
    class Port11434,Port3001 ai
    class Port22,Port80,Port443,Port27017 basic
    class Port5001,Port5555 special
```

### 主要服务端口 (⚠️ 2025.6更新 - 端口冲突解决方案)
| 端口 | 服务名称 | 协议 | 访问地址 | 说明 |
|------|----------|------|----------|------|
| **80** | AI中台统一入口 | HTTP | `http://192.168.110.88:80` | **🆕 统一访问入口(推荐)** |
| **3000** | Next.js前端 | HTTP | `http://192.168.110.88:3000` | 前端用户界面(直接访问) |
| **8000** | Django后端 | HTTP | `http://192.168.110.88:8000` | 后端API服务(直接访问) |
| **8080** | Dify AI平台 | HTTP | `http://192.168.110.88:8080` | **🆕 Dify AI应用构建平台** |
| **8000**/admin | Django管理后台 | HTTP | `http://192.168.110.88:80/admin/` | 后台管理(通过统一入口) |

### 数据库服务端口
| 端口 | 服务名称 | 协议 | 访问地址 | 说明 |
|------|----------|------|----------|------|
| **5432** | PostgreSQL 主数据库 | TCP | `localhost:5432` | 主数据库 |
| **5433** | PostgreSQL Dify | TCP | `localhost:5433` | Dify专用数据库 |
| **6379** | Redis 主缓存 | TCP | `localhost:6379` | 缓存服务 |
| **6380** | Redis Dify | TCP | `localhost:6380` | Dify专用缓存 |

### 监控系统端口
| 端口 | 服务名称 | 协议 | 访问地址 | 说明 |
|------|----------|------|----------|------|
| **3002** | Grafana主监控 | HTTP | `http://192.168.110.88:3002` | 主监控仪表板 |
| **9090** | Prometheus | HTTP | `http://localhost:9090` | 监控数据收集 |
| **9093** | AlertManager | HTTP | `http://localhost:9093` | 告警管理 |

### Dify AI平台端口 (⚠️ 2025.6更新)
| 端口 | 服务名称 | 协议 | 访问地址 | 说明 |
|------|----------|------|----------|------|
| **8080** | Dify AI平台 | HTTP | `http://192.168.110.88:8080` | **🆕 AI应用构建平台(主入口)** |
| **5001** | Dify API | HTTP | `http://localhost:5001` | Dify API服务(内部) |
| **8081** | Weaviate向量库 | HTTP | `http://localhost:8081` | 向量数据库 |

### 存储服务端口
| 端口 | 服务名称 | 协议 | 访问地址 | 说明 |
|------|----------|------|----------|------|
| **9000** | MinIO API | HTTP | `http://localhost:9000` | 对象存储API |
| **9001** | MinIO控制台 | HTTP | `http://localhost:9001` | MinIO管理界面 |
| **27017** | MongoDB | TCP | `localhost:27017` | 文档数据库 |

### GPU和AI服务端口 (可选)
| 端口 | 服务名称 | 协议 | 访问地址 | 说明 |
|------|----------|------|----------|------|
| **8100** | Triton HTTP | HTTP | `http://localhost:8100` | 推理服务HTTP |
| **8101** | Triton GRPC | GRPC | `localhost:8101` | 推理服务GRPC |
| **11434** | Ollama | HTTP | `http://localhost:11434` | LLM服务 |
| **3001** | OpenWebUI | HTTP | `http://localhost:3001` | AI Web界面 |

> **🔧 端口冲突解决方案 (v2025.6)**:
> - **端口80**: AI中台统一入口 (nginx反向代理到前端和后端)
> - **端口8080**: Dify AI平台 (从原端口80迁移，避免冲突)
> - **直接访问**: 仍可通过端口3000/8000直接访问前端/后端
> - **详细说明**: 参见 `minimal-example/docs/PORT_CONFLICT_RESOLUTION.md`

---

## 🔐 账号密码信息

> ⚠️ **安全提醒**: 生产环境部署时请务必修改所有默认密码！

### 数据库系统
| 系统/服务 | 用户名 | 密码 | 数据库名 | 说明 |
|----------|--------|------|----------|------|
| **PostgreSQL主数据库** | postgres | ai-platform-2024 | postgres | 超级管理员 |
| **PostgreSQL主数据库** | aiuser | aiuser-2024 | ai_platform | 应用用户 |
| **PostgreSQL Django** | django_user | django_password_2024 | ai_platform_django | Django专用 |
| **PostgreSQL Dify** | dify_user | dify_password | dify | Dify专用 |
| **Redis主缓存** | (无) | redis-2024 | - | 认证密码 |
| **Redis Dify** | (无) | (无密码) | - | Dify专用缓存 |
| **MongoDB** | root | changeThisToSecurePassword | admin | 超级管理员 |
| **MongoDB** | ai_platform_user | changeThisToSecurePassword | ai_platform | 应用用户 |

### 存储系统
| 系统/服务 | 用户名 | 密码 | 说明 |
|----------|--------|------|------|
| **MinIO对象存储** | minioadmin | minioadmin | 管理员账号 |
| **MinIO K8s** | minioadmin | minioadmin123 | K8s部署版本 |

### 监控系统
| 系统/服务 | 用户名 | 密码 | 说明 |
|----------|--------|------|------|
| **Grafana主监控** | admin | LSYgrafanaadmin2025 | 主监控实例 |
| **Grafana Docker** | admin | admin123 | Docker部署版本 |
| **Grafana GPU** | admin | gpu_monitor_2025 | GPU监控实例 |
| **Prometheus** | (无) | (无) | 无认证 |
| **AlertManager** | (无) | (无) | 无认证 |

### AI平台服务
| 系统/服务 | 用户名 | 密码 | 说明 |
|----------|--------|------|------|
| **Django管理后台** | admin | admin123 | Django超级用户(待创建) |
| **GPUStack** | admin | $w3d9uKKrVGz | GPU管理平台 |
| **OpenWebUI** | (首次设置) | (首次设置) | 首次访问时设置 |

### 审计监控系统
| 系统/服务 | 用户名 | 密码 | 说明 |
|----------|--------|------|------|
| **审计监控系统** | monitor_admin | Monitor@2024 | 审计管理员 |
| **Flower Celery** | admin | Monitor@2024 | 任务监控 |

### 数据库连接命令
```bash
# PostgreSQL连接
psql -h localhost -U aiuser -d ai_platform
psql -h localhost -U django_user -d ai_platform_django

# MongoDB连接
mongosh mongodb://ai_platform_user:changeThisToSecurePassword@localhost:27017/ai_platform

# Redis连接
redis-cli -h localhost -p 6379 -a redis-2024
```

---

## 🔧 端口冲突解决方案 (v2025.6重要更新)

### 问题背景
在项目发展过程中，Dify AI平台的nginx服务与AI中台服务在端口80上产生了冲突。经过架构调整，我们实施了以下解决方案：

### 解决方案架构
```mermaid
graph TB
    subgraph "端口80 - AI中台统一入口"
        NginxProxy[Nginx反向代理]
        NginxProxy --> Frontend[Next.js前端 :3000]
        NginxProxy --> Backend[Django后端 :8000]
    end
    
    subgraph "端口8080 - Dify AI平台"
        DifyPlatform[Dify AI平台]
        DifyPlatform --> DifyAPI[Dify API :5001]
        DifyPlatform --> DifyWeb[Dify Web界面]
        DifyPlatform --> Weaviate[Weaviate :8081]
    end
    
    User[用户] --> NginxProxy
    User --> DifyPlatform
    
    classDef primary fill:#e3f2fd
    classDef secondary fill:#f3e5f5
    class NginxProxy,Frontend,Backend primary
    class DifyPlatform,DifyAPI,DifyWeb,Weaviate secondary
```

### 端口分配策略
| 端口 | 服务 | 说明 | 状态 |
|------|------|------|------|
| **80** | AI中台统一入口 | nginx反向代理到前端/后端 | 🆕 新增 |
| **3000** | Next.js前端 | 直接访问前端应用 | ✅ 保持 |
| **8000** | Django后端 | 直接访问后端API | ✅ 保持 |
| **8080** | Dify AI平台 | Dify统一访问入口 | 🔄 迁移 |

### 访问方式说明
```bash
# 推荐访问方式
http://192.168.110.88:80        # AI中台统一入口 (前端+后端)
http://192.168.110.88:8080      # Dify AI平台

# 直接访问方式 (仍然支持)
http://192.168.110.88:3000      # 前端直接访问
http://192.168.110.88:8000      # 后端直接访问

# API文档访问
http://192.168.110.88:80/swagger/   # 通过统一入口
http://192.168.110.88:8000/swagger/ # 直接访问
```

### 配置文件位置
- **AI中台nginx配置**: `minimal-example/docker/ai-platform-nginx.conf`
- **Dify nginx配置**: `minimal-example/docker/dify-nginx.conf`
- **端口冲突解决文档**: `minimal-example/docs/PORT_CONFLICT_RESOLUTION.md`

### 环境管理增强
项目现在支持开发/生产环境一键切换：
```bash
# 开发环境 (localhost)
./scripts/env-config.sh dev

# 生产环境 (192.168.110.88)  
./scripts/env-config.sh prod

# 查看当前环境状态
./scripts/env-config.sh status
```

---

## 📁 项目目录结构

### 根目录结构
```
ZTZT/
├── README.md                     # 项目主文档
├── main.py                       # 主应用入口
├── LICENSE                       # 许可证文件
├── 项目交接文档.md               # 本文档
├── minimal-example/              # ⭐ 最小化AI中台示例
├── docs/                         # 📚 完整项目文档
├── dify/                         # 🤖 Dify AI平台源码
├── figs/                         # 🖼️ 系统界面截图
├── packages/                     # 📦 软件包和资源
├── configs/                      # ⚙️ 配置文件模板
└── monitoring/                   # 📊 监控配置
```

### 项目目录结构图

```mermaid
graph TB
    subgraph "ZTZT项目根目录"
        Root[ZTZT/]
        
        subgraph "核心文件"
            README[README.md]
            LICENSE[LICENSE]
            MainPy[main.py]
            Doc[项目交接文档.md]
        end
        
        subgraph "最小化示例"
            MinimalExample[minimal-example/]
            
            subgraph "启动脚本"
                QuickStart[quick-start.sh]
                Stop[stop.sh]
            end
            
            subgraph "后端 (Django)"
                Backend[backend/]
                Config[config/settings.py]
                Apps[apps/]
                Auth[authentication/]
                DataPlatform[data_platform/]
                AlgoPlatform[algorithm_platform/]
                ModelPlatform[model_platform/]
                ServicePlatform[service_platform/]
            end
            
            subgraph "前端 (Next.js)"
                Frontend[frontend/]
                Src[src/]
                AppRouter[app/]
                Components[components/]
                Lib[lib/]
            end
            
            subgraph "容器化"
                Docker[docker/]
                DockerCompose[docker-compose.yml]
                DifyCompose[dify-docker-compose.yml]
                Nginx[nginx/]
            end
            
            subgraph "工具脚本"
                Scripts[scripts/]
                SetupEnv[setup-environment.sh]
                EnvConfig[env-config.sh]
                HealthCheck[health-check.sh]
            end
        end
        
        subgraph "Dify AI平台"
            Dify[dify/]
            DifyAPI[api/]
            DifyWeb[web/]
            DifyDocker[docker/]
        end
        
        subgraph "文档系统"
            Docs[docs/]
            Deployment[deployment/]
            Development[development/]
            Info[info/]
        end
        
        subgraph "配置文件"
            Configs[configs/]
            DockerComposeConfigs[docker-compose/]
            HelmValues[helm-values/]
            Kubernetes[kubernetes/]
        end
        
        subgraph "资源文件"
            Packages[packages/]
            Figs[figs/]
            Monitoring[monitoring/]
        end
    end
    
    %% 连接关系
    Root --> README
    Root --> LICENSE
    Root --> MainPy
    Root --> Doc
    Root --> MinimalExample
    Root --> Dify
    Root --> Docs
    Root --> Configs
    Root --> Packages
    Root --> Figs
    Root --> Monitoring
    
    MinimalExample --> QuickStart
    MinimalExample --> Stop
    MinimalExample --> Backend
    MinimalExample --> Frontend
    MinimalExample --> Docker
    MinimalExample --> Scripts
    
    Backend --> Config
    Backend --> Apps
    Apps --> Auth
    Apps --> DataPlatform
    Apps --> AlgoPlatform
    Apps --> ModelPlatform
    Apps --> ServicePlatform
    
    Frontend --> Src
    Src --> AppRouter
    Src --> Components
    Src --> Lib
    
    Docker --> DockerCompose
    Docker --> DifyCompose
    Docker --> Nginx
    
    Scripts --> SetupEnv
    Scripts --> EnvConfig
    Scripts --> HealthCheck
    
    Dify --> DifyAPI
    Dify --> DifyWeb
    Dify --> DifyDocker
    
    Docs --> Deployment
    Docs --> Development
    Docs --> Info
    
    Configs --> DockerComposeConfigs
    Configs --> HelmValues
    Configs --> Kubernetes
    
    %% 样式定义
    classDef root fill:#e1f5fe
    classDef core fill:#f3e5f5
    classDef backend fill:#e8f5e8
    classDef frontend fill:#fff3e0
    classDef docker fill:#fce4ec
    classDef scripts fill:#f1f8e9
    classDef dify fill:#e0f2f1
    classDef docs fill:#fff8e1
    classDef configs fill:#f8bbd9
    classDef resources fill:#e8eaf6
    
    class Root,MinimalExample root
    class README,LICENSE,MainPy,Doc,QuickStart,Stop core
    class Backend,Config,Apps,Auth,DataPlatform,AlgoPlatform,ModelPlatform,ServicePlatform backend
    class Frontend,Src,AppRouter,Components,Lib frontend
    class Docker,DockerCompose,DifyCompose,Nginx,DifyDocker docker
    class Scripts,SetupEnv,EnvConfig,HealthCheck scripts
    class Dify,DifyAPI,DifyWeb dify
    class Docs,Deployment,Development,Info docs
    class Configs,DockerComposeConfigs,HelmValues,Kubernetes configs
    class Packages,Figs,Monitoring resources
```

### 最小化示例详细结构
```
minimal-example/
├── quick-start.sh               # 🚀 快速启动脚本
├── stop.sh                      # 🛑 停止脚本
├── README.md                    # 示例文档
├── backend/                     # 🐍 Django后端
│   ├── config/                  # Django配置
│   │   ├── settings.py         # 主配置文件
│   │   ├── urls.py             # URL路由
│   │   └── wsgi.py             # WSGI入口
│   ├── apps/                    # 应用模块
│   │   ├── authentication/     # 认证模块
│   │   ├── data_platform/      # 数据平台
│   │   ├── algorithm_platform/ # 算法平台
│   │   ├── model_platform/     # 模型平台
│   │   └── service_platform/   # 服务平台
│   ├── manage.py               # Django管理脚本
│   ├── requirements.txt        # Python依赖
│   └── venv/                   # Python虚拟环境
├── frontend/                    # 🎨 Next.js前端
│   ├── src/                    # 源代码
│   │   ├── app/                # App Router
│   │   ├── components/         # React组件
│   │   └── lib/                # 工具库
│   ├── package.json            # Node.js依赖
│   ├── next.config.js          # Next.js配置
│   └── node_modules/           # Node.js模块
├── docker/                      # 🐳 Docker配置
│   ├── docker-compose.yml      # 基础服务
│   ├── dify-docker-compose.yml # Dify服务
│   ├── docker-compose.offline.yml # 离线服务
│   └── nginx/                  # Nginx配置
├── scripts/                     # 📜 工具脚本
│   ├── setup-environment.sh    # 环境配置脚本
│   ├── env-config.sh           # 环境切换脚本
│   └── health-check.sh         # 健康检查脚本
├── logs/                        # 📄 日志文件
├── data/                        # 💾 数据文件
└── .env-status/                 # 🔧 环境状态文件
```

### 重要配置文件
| 文件路径 | 用途 | 重要性 |
|----------|------|--------|
| `minimal-example/backend/config/settings.py` | Django主配置 | ⭐⭐⭐ |
| `minimal-example/frontend/next.config.js` | Next.js配置 | ⭐⭐⭐ |
| `minimal-example/docker/docker-compose.yml` | Docker基础服务 | ⭐⭐⭐ |
| `minimal-example/docker/dify-docker-compose.yml` | Dify服务配置 | ⭐⭐ |
| `minimal-example/backend/.env` | 环境变量 | ⭐⭐⭐ |

---

## 🚀 快速启动指南

### 部署流程图

```mermaid
flowchart TD
    A[SSH连接服务器] --> B{首次部署?}
    B -->|是| C[运行环境配置脚本<br/>./scripts/setup-environment.sh]
    B -->|否| D[选择环境模式]
    
    C --> D
    
    D --> E{选择环境}
    E -->|开发环境| F[./scripts/env-config.sh dev]
    E -->|生产环境| G[./scripts/env-config.sh prod]
    
    F --> H[启动服务<br/>./quick-start.sh]
    G --> H
    
    H --> I{启用Dify?}
    I -->|是| J[默认启动所有服务]
    I -->|否| K[./quick-start.sh --no-dify]
    
    J --> L[检查服务状态]
    K --> L
    
    L --> M{服务正常?}
    M -->|是| N[✅ 部署完成<br/>访问应用界面]
    M -->|否| O[查看日志排查问题<br/>tail -f logs/backend.log]
    
    O --> P[修复问题]
    P --> H
    
    N --> Q[监控系统状态<br/>访问Grafana面板]
    
    style A fill:#e1f5fe
    style N fill:#e8f5e8
    style O fill:#ffebee
    style Q fill:#f3e5f5
```

### 第一次部署流程 (⚠️ v2025.6更新)

#### 1. 环境配置(仅首次)
```bash
# 登录服务器
ssh lsyzt@192.168.110.88

# 进入项目目录
cd /home/lsyzt/ZTZT/minimal-example

# 🆕 首次配置环境(一次性操作)
./scripts/setup-environment.sh

# 可选参数:
# ./scripts/setup-environment.sh --no-dify        # 跳过Dify环境配置
# ./scripts/setup-environment.sh --force-rebuild # 强制重新构建所有镜像
```

#### 2. 🆕 环境切换(开发/生产)
```bash
# 🆕 开发环境(localhost) - 自动配置所有localhost地址
./scripts/env-config.sh dev

# 🆕 生产环境(192.168.110.88) - 自动配置所有服务器地址  
./scripts/env-config.sh prod

# 🆕 查看当前环境状态
./scripts/env-config.sh status
```

#### 3. 启动所有服务
```bash
# 🆕 启动AI中台服务(默认包含Dify AI平台)
./quick-start.sh

# 如果要仅启动AI中台(不启动Dify)
./quick-start.sh --no-dify
```

#### 4. 🆕 验证服务访问
```bash
# AI中台统一入口(推荐)
curl http://192.168.110.88:80

# Dify AI平台
curl http://192.168.110.88:8080

# 前端直接访问
curl http://192.168.110.88:3000

# 后端直接访问  
curl http://192.168.110.88:8000/health
```

### 常用操作命令

#### 服务控制
```bash
# 停止所有服务
./stop.sh

# 查看服务状态
docker compose -f docker/docker-compose.yml ps
docker compose -f docker/dify-docker-compose.yml ps

# 查看服务日志
tail -f logs/backend.log
tail -f logs/frontend.log
```

#### 环境管理
```bash
# 查看当前环境状态
cat .env-status/current-env

# 重置环境配置
./scripts/setup-environment.sh --reset

# 健康检查
./scripts/health-check.sh
```

### 服务访问地址 (⚠️ v2025.6更新)

#### 🆕 推荐访问方式
- **AI中台统一入口**: http://192.168.110.88:80 (包含前端+后端+管理后台)
- **Dify AI平台**: http://192.168.110.88:8080 (AI应用构建平台)

#### 主要界面  
- **前端用户界面**: http://192.168.110.88:3000 (直接访问)
- **后端API服务**: http://192.168.110.88:8000 (直接访问)
- **Django管理后台**: http://192.168.110.88:80/admin/ (通过统一入口)
- **API文档(Swagger)**: http://192.168.110.88:80/swagger/ (通过统一入口)

#### 监控界面
- **Grafana主监控**: http://192.168.110.88:3002 (端口已调整)
- **Prometheus**: http://localhost:9090
- **MinIO控制台**: http://localhost:9001

---

## 🛠️ 开发环境配置

### 后端开发环境

#### Python环境
```bash
# 进入后端目录
cd /home/lsyzt/ZTZT/minimal-example/backend

# 激活虚拟环境
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt

# 运行迁移
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser

# 启动开发服务器
python manage.py runserver 0.0.0.0:8000
```

#### 后端API测试
```bash
# 健康检查
curl -X GET http://192.168.110.88:8000/api/v1/health/

# 获取API文档
curl -X GET http://192.168.110.88:8000/api/schema/
```

### 前端开发环境

#### Node.js环境
```bash
# 进入前端目录
cd /home/lsyzt/ZTZT/minimal-example/frontend

# 安装依赖
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build
```

#### 前端配置文件
```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  env: {
    NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL || 'http://192.168.110.88:8000',
  },
  async rewrites() {
    return [
      {
        source: '/api/:path*',
        destination: `${process.env.NEXT_PUBLIC_API_URL}/api/:path*`,
      },
    ]
  },
}

module.exports = nextConfig
```

---

## 📊 监控和运维

### 监控系统架构

```mermaid
graph TB
    subgraph "监控核心"
        Prometheus[Prometheus<br/>数据收集]
        Grafana[Grafana<br/>可视化]
        AlertManager[AlertManager<br/>告警管理]
    end
    
    subgraph "数据源"
        NodeExporter[Node Exporter<br/>系统指标]
        PostgreSQLExporter[PostgreSQL Exporter<br/>数据库指标]
        RedisExporter[Redis Exporter<br/>缓存指标]
        DCGMExporter[DCGM Exporter<br/>GPU指标]
        DjangoApp[Django App<br/>应用指标]
    end
    
    subgraph "可视化面板"
        SystemDashboard[系统概览<br/>仪表盘]
        DatabaseDashboard[数据库监控<br/>仪表盘]
        AppDashboard[应用性能<br/>仪表盘]
        GPUDashboard[GPU监控<br/>仪表盘]
    end
    
    subgraph "告警通知"
        EmailAlert[邮件通知]
        SMSAlert[短信通知]
        WebhookAlert[Webhook通知]
    end
    
    %% 数据流向
    NodeExporter --> Prometheus
    PostgreSQLExporter --> Prometheus
    RedisExporter --> Prometheus
    DCGMExporter --> Prometheus
    DjangoApp --> Prometheus
    
    Prometheus --> Grafana
    Prometheus --> AlertManager
    
    Grafana --> SystemDashboard
    Grafana --> DatabaseDashboard
    Grafana --> AppDashboard
    Grafana --> GPUDashboard
    
    AlertManager --> EmailAlert
    AlertManager --> SMSAlert
    AlertManager --> WebhookAlert
    
    %% 样式定义
    classDef core fill:#e3f2fd
    classDef exporter fill:#f1f8e9
    classDef dashboard fill:#fff8e1
    classDef alert fill:#fce4ec
    
    class Prometheus,Grafana,AlertManager core
    class NodeExporter,PostgreSQLExporter,RedisExporter,DCGMExporter,DjangoApp exporter
    class SystemDashboard,DatabaseDashboard,AppDashboard,GPUDashboard dashboard
    class EmailAlert,SMSAlert,WebhookAlert alert
```

### 主要监控指标

#### 系统监控
- **CPU使用率**: 服务器整体CPU负载
- **内存使用率**: 内存占用情况
- **磁盘使用率**: 存储空间使用情况
- **网络I/O**: 网络流量统计

#### 应用监控
- **Django应用**: HTTP请求响应时间、错误率
- **PostgreSQL**: 连接数、查询性能、锁等待
- **Redis**: 内存使用、命中率、连接数
- **Docker容器**: 容器状态、资源使用

#### 业务监控
- **API调用**: 各平台API调用量和响应时间
- **用户活动**: 用户登录、操作统计
- **任务执行**: 后台任务执行状态

### Grafana仪表盘

#### 预配置仪表盘
1. **系统概览仪表盘** - 整体系统状态
2. **数据库监控仪表盘** - PostgreSQL和Redis监控
3. **Docker容器仪表盘** - 容器资源使用
4. **应用性能仪表盘** - Django应用监控
5. **GPU监控仪表盘** - GPU使用情况(如果有GPU)

#### 访问方式
```bash
# 主Grafana监控
http://192.168.110.88:3000
用户名: admin
密码: LSYgrafanaadmin2025

# Docker部署的Grafana
http://localhost:3000
用户名: admin
密码: admin123
```

### 日志管理

#### 日志位置
```
minimal-example/logs/
├── backend.log          # Django后端日志
├── frontend.log         # Next.js前端日志
├── docker/              # Docker服务日志
├── nginx/               # Nginx访问日志
└── system/              # 系统日志
```

#### 日志查看命令
```bash
# 查看实时日志
tail -f logs/backend.log
tail -f logs/frontend.log

# 查看Docker服务日志
docker compose -f docker/docker-compose.yml logs -f
docker compose -f docker/dify-docker-compose.yml logs -f

# 查看特定服务日志
docker logs ai_platform_postgres -f
docker logs ai_platform_dify_api -f
```

---

## 🔧 常见问题排查 (⚠️ v2025.6更新)

### 🆕 端口冲突问题
> **最常见问题**: Dify与AI中台的端口80冲突已解决

#### 端口冲突解决方案
```bash
# 检查端口占用情况
netstat -tlnp | grep -E "(80|8080|3000|8000)"

# 如果发现端口80被其他服务占用:
sudo fuser -k 80/tcp  # 强制释放端口80

# 重新启动服务
./stop.sh && ./quick-start.sh
```

#### 🆕 端口访问验证
```bash
# 验证AI中台统一入口 (端口80)
curl -I http://192.168.110.88:80

# 验证Dify AI平台 (端口8080)  
curl -I http://192.168.110.88:8080

# 验证前端直接访问 (端口3000)
curl -I http://192.168.110.88:3000

# 验证后端直接访问 (端口8000)
curl -I http://192.168.110.88:8000
```

### 🆕 环境配置问题
#### 环境切换失败
```bash
# 检查当前环境状态
./scripts/env-config.sh status

# 强制重新切换环境
./scripts/env-config.sh dev --force
./scripts/env-config.sh prod --force

# 如果配置文件损坏，恢复备份
./scripts/env-config.sh restore
```

#### 配置文件缺失
```bash
# 检查必要的配置文件
ls -la .env*
ls -la .env-status/

# 重新生成配置文件
./scripts/env-config.sh dev
```

### 故障诊断流程

```mermaid
flowchart TD
    A[发现服务异常] --> B[检查服务状态]
    B --> C{服务类型}
    
    C -->|Web服务| D[检查端口占用<br/>netstat -tlnp]
    C -->|数据库| E[检查数据库连接<br/>docker exec -it xxx ping]
    C -->|Docker| F[检查容器状态<br/>docker ps]
    
    D --> G{端口被占用?}
    G -->|是| H[杀死占用进程<br/>kill -9 PID]
    G -->|否| I[检查应用日志<br/>tail -f logs/]
    
    E --> J{连接正常?}
    J -->|否| K[重启数据库容器<br/>docker restart]
    J -->|是| L[检查数据库配置]
    
    F --> M{容器运行?}
    M -->|否| N[启动容器<br/>docker start]
    M -->|异常| O[查看容器日志<br/>docker logs]
    
    H --> P[重启服务]
    I --> Q{找到错误?}
    K --> P
    L --> R[检查配置文件]
    N --> P
    O --> S[分析错误信息]
    
    Q -->|是| S
    Q -->|否| T[检查系统资源<br/>top, df -h]
    
    R --> U[修复配置]
    S --> V[修复问题]
    T --> W[清理资源]
    
    U --> P
    V --> P
    W --> P
    
    P --> X[验证服务正常]
    X --> Y{服务正常?}
    Y -->|是| Z[✅ 问题解决]
    Y -->|否| AA[深入分析<br/>联系技术支持]
    
    style A fill:#ffebee
    style Z fill:#e8f5e8
    style AA fill:#fff3e0
    style S fill:#f3e5f5
```

### 服务启动问题

#### 1. 🆕 端口占用问题 (重点关注)
```bash
# 检查关键端口占用 (新架构)
netstat -tlnp | grep -E "(80|8080|3000|8000|5432|6379)"

# 端口80 (AI中台统一入口)
sudo fuser -k 80/tcp

# 端口8080 (Dify AI平台)  
sudo fuser -k 8080/tcp

# 其他关键端口
sudo fuser -k 3000/tcp  # 前端
sudo fuser -k 8000/tcp  # 后端

# 清理Docker网络
docker network prune
```

#### 2. 🆕 统一入口nginx问题
```bash
# 检查AI中台nginx配置
cat docker/ai-platform-nginx.conf

# 检查nginx容器状态
docker ps | grep nginx

# 重启nginx代理
docker compose -f docker/docker-compose.yml restart ai-platform-nginx
```

#### 3. 🆕 Dify服务问题
```bash
# 检查Dify服务状态
docker compose -f docker/dify-docker-compose.yml ps

# 检查Dify API连接
curl http://localhost:5001/health

# 重启Dify服务
docker compose -f docker/dify-docker-compose.yml restart
```

#### 2. Docker服务问题
```bash
# 检查Docker服务状态
systemctl status docker

# 重启Docker服务
sudo systemctl restart docker

# 检查Docker网络
docker network ls | grep ai_platform_network

# 重建Docker网络
docker network create ai_platform_network
```

#### 3. 数据库连接问题
```bash
# 检查PostgreSQL状态
docker exec -it ai_platform_postgres pg_isready

# 检查Redis状态
docker exec -it ai_platform_redis redis-cli ping

# 重置数据库连接
docker compose -f docker/docker-compose.yml restart postgres redis
```

### 权限问题

#### 文件权限
```bash
# 检查项目文件权限
ls -la /home/lsyzt/ZTZT/minimal-example/

# 修复脚本执行权限
chmod +x /home/lsyzt/ZTZT/minimal-example/quick-start.sh
chmod +x /home/lsyzt/ZTZT/minimal-example/stop.sh
chmod +x /home/lsyzt/ZTZT/minimal-example/scripts/*.sh

# 修复日志目录权限
chmod 755 /home/lsyzt/ZTZT/minimal-example/logs/
```

#### Docker权限
```bash
# 将用户添加到docker组
sudo usermod -aG docker lsyzt

# 重新登录或重新加载用户组
newgrp docker
```

### 性能问题

#### 系统资源检查
```bash
# 检查CPU和内存使用
top
htop

# 检查磁盘使用
df -h
du -sh /home/lsyzt/ZTZT/

# 检查Docker资源使用
docker stats
```

#### 数据库性能
```bash
# PostgreSQL性能检查
docker exec -it ai_platform_postgres psql -U aiuser -d ai_platform -c "
SELECT 
    datname,
    numbackends,
    xact_commit,
    xact_rollback,
    blks_read,
    blks_hit
FROM pg_stat_database 
WHERE datname = 'ai_platform';"

# Redis性能检查
docker exec -it ai_platform_redis redis-cli info stats
```

### 网络问题

#### 连接测试
```bash
# 测试本地服务连通性
curl -f http://localhost:8000/api/v1/health/
curl -f http://localhost:3000

# 测试外部访问
curl -f http://192.168.110.88:8000/api/v1/health/
curl -f http://192.168.110.88:3000

# 检查防火墙状态
sudo ufw status
```

### 故障恢复流程

#### 1. 快速重启流程
```bash
# 停止所有服务
./stop.sh

# 等待10秒
sleep 10

# 重新启动
./quick-start.sh
```

#### 2. 完全重置流程
```bash
# 停止所有服务
./stop.sh

# 清理Docker资源
docker system prune -f

# 重建环境
./scripts/setup-environment.sh --reset

# 重新配置环境
./scripts/env-config.sh prod

# 重新启动
./quick-start.sh
```

---

## ⚠️ 重要注意事项

### 安全要求

#### 1. 密码安全
- 🚨 **生产环境必须修改所有默认密码**
- 🔒 使用强密码策略(大小写字母+数字+特殊字符)
- 🔄 定期轮换密码(建议每90天)
- 📝 建议使用密钥管理系统

#### 2. 网络安全
- 🔒 生产环境仅允许内网访问管理接口
- 🛡️ 配置适当的防火墙规则
- 🔐 启用HTTPS加密传输
- 👥 实施基于角色的访问控制

#### 3. 数据安全
- 💾 定期备份重要数据库
- 🔐 启用数据库加密
- 📋 建立数据访问审计日志
- 🗄️ 定期清理临时数据

### 运维要求

#### 1. 监控告警
- 📊 确保监控系统正常运行
- 🔔 配置关键指标告警阈值
- 📧 设置告警通知渠道
- 📈 定期检查监控数据

#### 2. 备份策略
- 🗂️ 每日备份PostgreSQL数据库
- 💾 每周备份完整系统配置
- ☁️ 备份文件存储到远程位置
- 🔄 定期测试备份恢复流程

#### 3. 更新维护
- 🔄 定期更新系统安全补丁
- 📦 及时更新Docker镜像
- 🧪 在测试环境验证更新
- 📋 维护操作前进行备份

### 环境管理

#### 1. 开发环境
- 💻 使用localhost进行本地开发
- 🔧 开发环境独立的数据库
- 📝 开发环境允许调试模式
- 🧪 集成自动化测试

#### 2. 生产环境
- 🏭 使用192.168.110.88的生产服务器
- 🔒 关闭调试模式和详细错误信息
- 📊 启用完整的监控和日志
- 🛡️ 严格的安全配置

### 应急预案

#### 应急处理流程图

```mermaid
flowchart TD
    A[🚨 发现系统异常] --> B{事件类型}
    
    B -->|服务中断| C[服务中断处理]
    B -->|数据丢失| D[数据丢失处理]
    B -->|安全事件| E[安全事件处理]
    B -->|性能问题| F[性能问题处理]
    
    subgraph "服务中断处理流程"
        C --> C1[立即检查监控系统<br/>确定故障范围]
        C1 --> C2[查看服务日志<br/>tail -f logs/]
        C2 --> C3[确定故障原因]
        C3 --> C4{故障类型}
        C4 -->|端口冲突| C5[清理占用进程<br/>kill -9 PID]
        C4 -->|容器异常| C6[重启Docker服务<br/>docker restart]
        C4 -->|配置错误| C7[修复配置文件]
        C5 --> C8[重启服务<br/>./quick-start.sh]
        C6 --> C8
        C7 --> C8
        C8 --> C9[验证服务恢复]
    end
    
    subgraph "数据丢失处理流程"
        D --> D1[🛑 立即停止相关服务<br/>./stop.sh]
        D1 --> D2[评估数据丢失范围]
        D2 --> D3[检查备份可用性]
        D3 --> D4{有可用备份?}
        D4 -->|是| D5[从备份恢复数据<br/>pg_restore/redis-cli]
        D4 -->|否| D6[尝试数据恢复工具]
        D5 --> D7[验证数据完整性]
        D6 --> D7
        D7 --> D8[重启服务并测试]
    end
    
    subgraph "安全事件处理流程"
        E --> E1[🔒 立即隔离系统<br/>断网/停机]
        E1 --> E2[收集安全事件证据<br/>日志/截图]
        E2 --> E3[分析攻击方式]
        E3 --> E4[评估影响范围]
        E4 --> E5[修复安全漏洞]
        E5 --> E6[更换所有密码]
        E6 --> E7[强化安全措施]
        E7 --> E8[监控异常活动]
    end
    
    subgraph "性能问题处理流程"
        F --> F1[检查系统资源<br/>top, df -h]
        F1 --> F2[分析性能瓶颈]
        F2 --> F3{问题类型}
        F3 -->|CPU高| F4[优化进程配置]
        F3 -->|内存不足| F5[增加内存/优化缓存]
        F3 -->|磁盘满| F6[清理日志文件]
        F3 -->|网络慢| F7[优化网络配置]
        F4 --> F8[重启相关服务]
        F5 --> F8
        F6 --> F8
        F7 --> F8
        F8 --> F9[监控性能指标]
    end
    
    C9 --> G[📝 记录故障详情]
    D8 --> G
    E8 --> G
    F9 --> G
    
    G --> H[📋 编写故障报告]
    H --> I[🔍 根因分析]
    I --> J[📈 改进措施]
    J --> K[✅ 完成处理]
    
    %% 样式定义
    classDef emergency fill:#ffcdd2
    classDef service fill:#e1f5fe
    classDef data fill:#e8f5e8
    classDef security fill:#fff3e0
    classDef performance fill:#f3e5f5
    classDef completed fill:#c8e6c9
    
    class A emergency
    class C,C1,C2,C3,C4,C5,C6,C7,C8,C9 service
    class D,D1,D2,D3,D4,D5,D6,D7,D8 data
    class E,E1,E2,E3,E4,E5,E6,E7,E8 security
    class F,F1,F2,F3,F4,F5,F6,F7,F8,F9 performance
    class K completed
```

#### 1. 服务中断处理
1. 立即检查监控系统确定故障范围
2. 查看相关服务日志确定故障原因
3. 根据故障类型执行对应恢复流程
4. 记录故障详情和恢复过程
5. 后续进行故障根因分析

#### 2. 数据丢失处理
1. 立即停止相关服务防止数据进一步损坏
2. 评估数据丢失范围和影响
3. 从最近的备份恢复数据
4. 验证数据完整性
5. 重新启动服务并验证功能

#### 3. 安全事件处理
1. 立即隔离受影响的系统
2. 收集和保存安全事件证据
3. 分析攻击方式和影响范围
4. 修复安全漏洞
5. 强化安全措施

---

## 📞 联系方式 (⚠️ v2025.6更新)

### 项目交接信息
| 角色 | 联系方式 | 负责范围 |
|------|----------|----------|
| **原开发者** | lsyzt | 整体系统架构、技术支持 |
| **服务器管理** | 192.168.110.88 | Ubuntu 24.04 LTS服务器 |
| **文档位置** | `/home/lsyzt/ZTZT/docs/` | 完整项目文档 |
| **交接文档版本** | v2025.6 | 🆕 包含端口冲突解决方案 |

### 🆕 最新架构访问地址
- **AI中台统一入口**: http://192.168.110.88:80 (推荐访问方式)
- **Dify AI平台**: http://192.168.110.88:8080 (AI应用构建)
- **系统监控**: http://192.168.110.88:3002 (Grafana)
- **API文档**: http://192.168.110.88:80/swagger/ (通过统一入口)

### 技术支持
- **项目仓库**: `/home/lsyzt/ZTZT/`
- **技术文档**: `/home/lsyzt/ZTZT/docs/`
- **交接文档**: `/home/lsyzt/ZTZT/项目交接文档.md`
- **🆕 端口冲突解决文档**: `/home/lsyzt/ZTZT/minimal-example/docs/PORT_CONFLICT_RESOLUTION.md`
- **🆕 环境配置文档**: `/home/lsyzt/ZTZT/minimal-example/docs/environment-config.md`

### 🆕 关键更新日志
- **版本**: v2025.6 (2025年6月26日)
- **核心更新**: 端口冲突解决，统一访问入口，环境管理系统
- **架构变更**: 端口80(AI中台) + 端口8080(Dify)
- **新增功能**: 开发/生产环境一键切换

---

## 📋 交接确认清单

### 技能要求树状图

```mermaid
mindmap
  root)接手项目需要的技能(
    基础技能
      Linux系统管理
        SSH连接
        文件权限管理
        系统监控命令
      Docker容器技术
        Docker基础命令
        Docker Compose
        容器网络管理
      Git版本控制
        代码拉取推送
        分支管理
        冲突解决
    
    后端技能
      Python开发
        Django框架
        Django REST Framework
        虚拟环境管理
      数据库管理
        PostgreSQL操作
        Redis缓存管理
        数据备份恢复
      API开发
        RESTful设计
        JWT认证
        API文档编写
    
    前端技能
      Node.js环境
        npm包管理
        环境配置
        依赖管理
      React开发
        Next.js框架
        TypeScript语法
        组件开发
      Web技术
        HTML/CSS
        JavaScript ES6+
        响应式设计
    
    运维技能
      监控系统
        Prometheus配置
        Grafana仪表盘
        告警设置
      日志管理
        日志查看分析
        问题排查
        性能调优
      安全管理
        权限控制
        密码管理
        网络安全
    
    AI平台技能
      Dify平台
        AI应用创建
        工作流配置
        模型管理
      大语言模型
        模型部署
        API调用
        性能优化
      GPU管理
        GPU监控
        资源分配
        性能调优
```
---

## 🎯 项目核心架构总览

### ZTZT AI中台核心组件关系图

```mermaid
graph TB
    subgraph "🌐 外部访问层"
        Browser[用户浏览器]
        APIClient[API客户端]
        Mobile[移动端应用]
    end
    
    subgraph "🔒 安全接入层"
        LoadBalancer[负载均衡器<br/>Nginx]
        SSL[SSL证书<br/>HTTPS加密]
        Firewall[防火墙<br/>访问控制]
    end
    
    subgraph "🎨 前端展示层"
        WebApp[Web应用<br/>Next.js + React]
        AdminPanel[管理后台<br/>Django Admin]
        MonitorDash[监控面板<br/>Grafana]
        DifyUI[AI平台界面<br/>Dify Web]
    end
    
    subgraph "🔗 API网关层"
        APIGateway[API网关<br/>Django REST API]
        AuthService[认证服务<br/>JWT + OAuth]
        RateLimit[限流控制<br/>Redis]
        APIDoc[API文档<br/>Swagger/OpenAPI]
    end
    
    subgraph "🤖 应用中台层"
        DataPlatform[数据中台<br/>数据处理与分析]
        AlgoPlatform[算法中台<br/>ML/AI算法管理]
        ModelPlatform[模型中台<br/>模型训练与部署]
        ServicePlatform[服务中台<br/>微服务编排]
        DifyPlatform[AI平台<br/>对话/工作流/智能体]
    end
    
    subgraph "💾 数据存储层"
        PostgreSQL[关系数据库<br/>PostgreSQL]
        Redis[缓存数据库<br/>Redis]
        MinIO[对象存储<br/>MinIO]
        VectorDB[向量数据库<br/>Weaviate]
        MongoDB[文档数据库<br/>MongoDB]
    end
    
    subgraph "🔥 AI计算层"
        LLMService[大语言模型<br/>Ollama/GPT]
        GPUCluster[GPU集群<br/>推理加速]
        TritonServer[推理服务器<br/>Triton]
        MLPipeline[ML流水线<br/>训练/推理]
    end
    
    subgraph "📊 监控运维层"
        Prometheus[指标收集<br/>Prometheus]
        Grafana[可视化监控<br/>Grafana]
        AlertManager[告警管理<br/>AlertManager]
        LogSystem[日志系统<br/>ELK Stack]
    end
    
    subgraph "🐳 基础设施层"
        Docker[容器运行时<br/>Docker Engine]
        K8s[容器编排<br/>Kubernetes]
        Network[网络管理<br/>Docker Network]
        Storage[存储管理<br/>Persistent Volume]
    end
    
    %% 连接关系
    Browser --> LoadBalancer
    APIClient --> LoadBalancer
    Mobile --> LoadBalancer
    
    LoadBalancer --> SSL
    SSL --> Firewall
    Firewall --> WebApp
    Firewall --> AdminPanel
    Firewall --> MonitorDash
    Firewall --> DifyUI
    
    WebApp --> APIGateway
    AdminPanel --> APIGateway
    DifyUI --> DifyPlatform
    
    APIGateway --> AuthService
    APIGateway --> RateLimit
    APIGateway --> DataPlatform
    APIGateway --> AlgoPlatform
    APIGateway --> ModelPlatform
    APIGateway --> ServicePlatform
    
    DataPlatform --> PostgreSQL
    DataPlatform --> MongoDB
    DataPlatform --> MinIO
    
    AlgoPlatform --> PostgreSQL
    AlgoPlatform --> MinIO
    AlgoPlatform --> MLPipeline
    
    ModelPlatform --> PostgreSQL
    ModelPlatform --> MinIO
    ModelPlatform --> LLMService
    ModelPlatform --> GPUCluster
    ModelPlatform --> TritonServer
    
    ServicePlatform --> PostgreSQL
    ServicePlatform --> Redis
    
    DifyPlatform --> PostgreSQL
    DifyPlatform --> Redis
    DifyPlatform --> LLMService
    DifyPlatform --> VectorDB
    
    LLMService --> GPUCluster
    TritonServer --> GPUCluster
    MLPipeline --> GPUCluster
    
    Prometheus --> DataPlatform
    Prometheus --> AlgoPlatform
    Prometheus --> ModelPlatform
    Prometheus --> ServicePlatform
    Prometheus --> PostgreSQL
    Prometheus --> Redis
    Prometheus --> GPUCluster
    
    Grafana --> Prometheus
    AlertManager --> Prometheus
    MonitorDash --> Grafana
    
    Docker --> DataPlatform
    Docker --> AlgoPlatform
    Docker --> ModelPlatform
    Docker --> ServicePlatform
    Docker --> DifyPlatform
    Docker --> PostgreSQL
    Docker --> Redis
    Docker --> MinIO
    
    K8s --> Docker
    Network --> Docker
    Storage --> Docker
    
    %% 样式定义
    classDef external fill:#ffcdd2
    classDef security fill:#e8f5e8
    classDef frontend fill:#e1f5fe
    classDef api fill:#f3e5f5
    classDef platform fill:#fff3e0
    classDef data fill:#e0f2f1
    classDef ai fill:#f1f8e9
    classDef monitor fill:#fff8e1
    classDef infra fill:#fafafa
    
    class Browser,APIClient,Mobile external
    class LoadBalancer,SSL,Firewall security
    class WebApp,AdminPanel,MonitorDash,DifyUI frontend
    class APIGateway,AuthService,RateLimit,APIDoc api
    class DataPlatform,AlgoPlatform,ModelPlatform,ServicePlatform,DifyPlatform platform
    class PostgreSQL,Redis,MinIO,VectorDB,MongoDB data
    class LLMService,GPUCluster,TritonServer,MLPipeline ai
    class Prometheus,Grafana,AlertManager,LogSystem monitor
    class Docker,K8s,Network,Storage infra
```

---

## 🚨 v2025.6 重要更新总结

### 🔧 核心架构变更
1. **端口冲突解决**: 
   - 端口80: AI中台统一入口 (nginx反向代理)
   - 端口8080: Dify AI平台 (从端口80迁移)
   - 端口3002: Grafana监控 (从端口3000调整)

2. **🆕 统一访问入口**: 
   - 推荐通过 `http://192.168.110.88:80` 访问AI中台
   - 包含前端、后端、管理后台、API文档

3. **🆕 环境管理系统**:
   - 开发/生产环境一键切换: `./scripts/env-config.sh dev/prod`
   - 自动IP配置: localhost ↔ 192.168.110.88
   - 配置同步: 前端、后端、Docker配置自动同步

### 📋 接手人员必读
1. **优先使用统一入口**: `http://192.168.110.88:80` 
2. **Dify AI平台**: `http://192.168.110.88:8080`
3. **监控面板**: `http://192.168.110.88:3002`
4. **环境切换**: 使用 `./scripts/env-config.sh status` 查看当前状态
5. **端口说明**: 详见 `/minimal-example/docs/PORT_CONFLICT_RESOLUTION.md`

### ⚠️ 关键注意事项
- **不要直接修改端口配置**: 使用提供的脚本进行环境管理
- **生产环境访问**: 确保使用端口80统一入口
- **问题排查**: 优先检查端口冲突和环境配置状态
- **配置备份**: 环境切换会自动备份，但建议手动备份重要配置

---

**📚 文档完成日期**: 2025年6月26日  
**📋 交接文档版本**: v2025.6  
**🎯 项目状态**: 生产就绪，端口冲突已解决  
**🚀 快速开始**: `cd minimal-example && ./scripts/env-config.sh prod && ./quick-start.sh`
```
---

> 📝 **文档维护说明**:  
> 本文档随系统部署进展持续更新。如发现信息不准确或需要补充，请及时更新此文档。  
> 生产环境部署前务必进行完整的安全审查和测试验证。
